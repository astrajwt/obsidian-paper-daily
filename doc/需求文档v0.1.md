# Paper Daily — 需求文档 v0.1

> 反推版本，基于当前实际代码（2026-02-28）整理。以代码实现为准，凡与早期设计有出入之处，均以本文档为准。

---

## 1. 产品概述

**Paper Daily** 是一款 Obsidian 插件，核心目标是：

- 每日自动从 **arXiv** 和 **HuggingFace Daily Papers** 拉取指定领域论文
- 对论文进行多维度评分排名
- 调用 LLM 生成结构化每日摘要，写入用户 Vault
- 支持历史回补、去重、PDF 下载等增强功能

**目标用户：** 关注 AI/ML 前沿研究的工程师、研究者，尤其关注 LLM 训练、推理、RL、Agent 等方向。

---

## 2. 插件基础信息

| 字段 | 值 |
|------|----|
| Plugin ID | `paper-daily` |
| 最低 Obsidian 版本 | 0.15.0 |
| 语言 | TypeScript (ES2018, strict) |
| 构建工具 | esbuild |
| 依赖 | `@anthropic-ai/sdk`（Anthropic Claude 接入用） |
| Vault 输出根目录 | 可配置，默认 `PaperDaily/` |

---

## 3. Vault 目录结构

插件在 Vault 内写入如下目录结构：

```
PaperDaily/
  inbox/
    2026-02-28.md          # 每日摘要 markdown
  papers/
    2026-02-28.json        # 每日论文快照（含评分）
    pdf/
      2501.12345.pdf       # 下载的 PDF（可选）
  cache/
    state.json             # 运行状态（最后一次运行时间、错误信息）
    seen_ids.json          # 去重表（paperId → 首次出现日期）
    hf_track.json          # HuggingFace 论文连续出现追踪
    runs.log               # 运行日志（追加写入）
```

> weekly/、monthly/、templates/ 目录在当前代码中**尚未实现**，为预留扩展项。

---

## 4. 数据模型

### 4.1 Paper（论文）

```ts
type Paper = {
  // 基础字段
  id: string;                 // 唯一 ID，格式：arxiv:2501.12345v2
  title: string;
  authors: string[];
  abstract: string;
  categories: string[];       // arXiv 分类，如 ["cs.AI", "cs.LG"]
  published: string;          // ISO 8601
  updated: string;            // ISO 8601
  links: {
    html?: string;            // arXiv 页面链接
    pdf?: string;             // PDF 直链
    hf?: string;              // HuggingFace 页面链接（HF 来源时有）
  };
  source: "arxiv" | "rss" | "custom" | "hf";

  // HuggingFace 专有字段
  hfUpvotes?: number;         // HF 社区点赞数
  hfStreak?: number;          // 在 HF Daily Papers 连续出现天数

  // 计算字段（运行时生成，存入 JSON 快照）
  interestHits?: string[];              // 命中的兴趣关键词
  directionScores?: Record<string, number>; // 各方向得分
  topDirections?: string[];             // 排名前 N 的方向名称
  llmScore?: number;                    // LLM 质量评分（1–10）
  llmSummary?: string;                  // LLM 对该论文的一句话总结
};
```

### 4.2 DailySnapshot（每日快照）

```ts
type DailySnapshot = {
  date: string;        // YYYY-MM-DD
  papers: Paper[];     // 含计算字段的完整论文列表
  fetchedAt: string;   // ISO 时间戳
  error?: string;      // 若有错误，记录原因
};
```

### 4.3 RunState（运行状态）

```ts
type RunState = {
  lastDailyRun?: string;   // ISO 时间戳
  lastError?: {
    time: string;
    stage: "fetch" | "llm" | "write";
    message: string;
  };
};
```

---

## 5. 配置项（Settings Schema）

### 5.1 arXiv 拉取配置

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `categories` | `string[]` | `["cs.AI","cs.LG","cs.CL"]` | arXiv 分类列表 |
| `keywords` | `string[]` | `[]` | 查询关键词（与分类做 AND 组合） |
| `interestKeywords` | `InterestKeyword[]` | 见下 | 兴趣关键词及权重（用于评分/高亮） |
| `maxResultsPerDay` | `number` | `20` | 每日最终保留论文上限 |
| `sortBy` | `"submittedDate" \| "lastUpdatedDate"` | `"submittedDate"` | arXiv 排序方式 |
| `timeWindowHours` | `number` | `30` | 拉取时间窗口（小时），过滤 published 时间 |

**默认兴趣关键词（14 个）：**

| 关键词 | 权重 |
|--------|------|
| rlhf | 3 |
| agent / agentic rl | 3 |
| kv cache / speculative decoding | 3 |
| reward model | 3 |
| ppo / dpo / grpo | 2 |
| moe / pretraining / scaling / long context / multimodal | 2 |

### 5.2 方向（Directions）配置

```ts
type DirectionConfig = {
  name: string;
  weight: number;                          // 方向权重系数
  match: {
    keywords: string[];                    // 在 title+abstract 中匹配
    categories?: string[];                 // 可选：分类加成（+0.5 per hit）
  };
};
```

**默认预设 9 个方向：**

| 方向名称 | 权重 | 核心关键词（部分） |
|----------|------|--------------------|
| RLHF & Post-training | 1.5 | rlhf, ppo, dpo, grpo, reward model |
| Agentic RL | 1.4 | agent, tool, planner, react, multi-agent |
| Pre-training | 1.4 | pretraining, scaling law, data curation |
| Inference Serving | 1.3 | kv cache, pagedattention, speculative, vllm |
| Training Systems | 1.2 | fsdp, zero, deepspeed, megatron |
| MoE | 1.2 | moe, expert, routing, alltoall |
| Long Context & Efficiency | 1.2 | long context, rope, rope scaling |
| Multimodal | 1.1 | multimodal, vision, vlm, image |
| Quantization & Compression | 1.1 | quantization, pruning, distillation |

`directionTopK`：默认 5，每篇论文保留前 N 个方向标签。

### 5.3 LLM 提供商配置

```ts
type LLMConfig = {
  provider: "openai_compatible" | "anthropic";
  baseUrl: string;
  apiKey: string;
  model: string;
  temperature: number;     // 默认 0.3
  maxTokens: number;       // 默认 4096
  dailyPromptTemplate: string;    // 每日摘要 prompt 模板
  weeklyPromptTemplate: string;   // 周报 prompt 模板（预留）
  monthlyPromptTemplate: string;  // 月报 prompt 模板（预留）
};
```

**内置 LLM 提供商预设（8 个）：**

| 名称 | Base URL |
|------|----------|
| DeepSeek | `api.deepseek.com/v1` |
| OpenAI | `api.openai.com/v1` |
| Anthropic (Claude) | 使用 SDK，无需 baseUrl |
| GLM/智谱 | `open.bigmodel.cn/api/paas/v4` |
| MiniMax | `api.minimax.chat/v1` |
| Moonshot/Kimi | `api.moonshot.cn/v1` |
| Qwen/通义 | `dashscope.aliyuncs.com/compatible-mode/v1` |
| Custom | 用户自填 |

默认值：OpenAI Compatible，模型 `gpt-4o-mini`。

**Prompt 模板占位符：**

| 占位符 | 含义 |
|--------|------|
| `{{date}}` | 当日日期（YYYY-MM-DD） |
| `{{topDirections}}` | 预计算的方向排名字符串 |
| `{{papers_json}}` | Top 10 论文 JSON（含计算字段） |
| `{{hf_papers_json}}` | HF 当日论文 JSON |
| `{{language}}` | 输出语言（Chinese/English） |

### 5.4 输出配置

| 字段 | 类型 | 默认值 |
|------|------|--------|
| `rootFolder` | `string` | `"PaperDaily"` |
| `language` | `"zh" \| "en"` | `"zh"` |
| `includeAbstract` | `boolean` | `true` |
| `includePdfLink` | `boolean` | `true` |

### 5.5 调度配置

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `schedule.dailyTime` | `string (HH:MM)` | `"08:30"` | 每日自动运行时间 |

调度器每 60 秒 tick 一次，用 `lastDailyRun` 时间戳判断是否需要运行，避免同一天重复触发。

### 5.6 HuggingFace 来源配置

| 字段 | 类型 | 默认值 |
|------|------|--------|
| `hfSource.enabled` | `boolean` | `true` |
| `hfSource.lookbackDays` | `number` | `3` |
| `hfSource.dedup` | `boolean` | `false` |

lookbackDays：若当日 HF 无数据（周末/节假日），向前回溯最多 N 天。

### 5.7 热度趋势配置

| 字段 | 类型 | 默认值 |
|------|------|--------|
| `trending.enabled` | `boolean` | `true` |
| `trending.topK` | `number` | `5` |
| `trending.minHotness` | `number` | `2` |

热度分：`0–12` 分，由版本号、交叉分类数、发布时效、HF 点赞数四项计算。

### 5.8 PDF 下载配置

| 字段 | 类型 | 默认值 |
|------|------|--------|
| `paperDownload.savePdf` | `boolean` | `false` |

开启后，每篇论文的 PDF 以 `{arxivId}.pdf` 保存至 `papers/pdf/`，下载间隔 1.2s 防限速。

### 5.9 回补配置

| 字段 | 类型 | 默认值 |
|------|------|--------|
| `backfillMaxDays` | `number` | `30` |

---

## 6. 数据来源

### 6.1 arXiv（已实现）

- **API**：`https://export.arxiv.org/api/query`（Atom XML）
- **查询构建**：
  - 分类子句：`(cat:cs.AI OR cat:cs.LG OR ...)`
  - 关键词子句：`(all:"keyword1" OR all:"keyword2" OR ...)`
  - 若关键词为空，仅用分类子句
  - 两者均有时，以 AND 组合
- **过量拉取**：`max_results = maxResultsPerDay × 3`，拉取后再按时间窗口过滤，取 Top N
- **时间过滤**：以 `published` 字段过滤，保留在 `now - timeWindowHours` 之后的论文
- **限速处理**：遇 HTTP 429，按 5s / 15s / 30s 指数退避重试（最多 3 次）
- **字段提取**：title、abstract（summary）、authors、categories、published/updated、html/pdf links

### 6.2 HuggingFace Daily Papers（已实现）

- **API**：`https://huggingface.co/api/daily_papers?date=YYYY-MM-DD`
- **行为**：若当日无数据，向前回溯至 `lookbackDays` 天
- **字段提取**：arXiv ID、title、authors、upvotes、published 日期
- **链接构建**：同时生成 arXiv 链接 + HF 页面链接
- **与 arXiv 合并**：按 paper ID 匹配，将 HF 的 upvotes 合并到 arXiv 论文对象中
- **连续出现追踪**：`hfTrackStore` 记录论文在 HF Daily Papers 中的出现次数与连续天数

### 6.3 RSS 来源（Stub，未实现）

- 文件存在（`rssSource.ts`），接口预留，`fetch()` 始终返回空数组
- 默认禁用，Settings UI 有入口但标记为 Beta

### 6.4 Custom API 来源（Stub，未实现）

- 同上，文件存在，接口预留，未实现逻辑

---

## 7. 评分与排名

### 7.1 兴趣关键词匹配

- 对每篇论文，将 title + abstract 转小写，逐一检测兴趣关键词是否为子串
- 命中存入 `interestHits[]`
- 加权得分：命中关键词权重之和 → `interestScore`

### 7.2 方向评分

对每个方向：
1. 统计该方向所有关键词在 title+abstract（小写）中的命中次数
2. 若论文分类命中方向的 `categories` 列表且已有得分，额外加 0.5
3. 乘以 `direction.weight`
4. 得分 > 0 才记录

聚合：`directionName → 当日所有论文该方向得分之和`，用于"今日热门方向"排名。

### 7.3 热度评分（Hotness）

| 维度 | 分值规则 |
|------|----------|
| 版本号 | v2=1, v3=2, v4+=3 |
| 交叉分类数 | 2个=1, 3个=2, 4+个=3 |
| 发布时效 | <24h=3, <48h=2, <72h=1 |
| HF 点赞数 | ≥1=1, ≥6=2, ≥21=3 |
| **总分上限** | **12** |

### 7.4 综合排名公式

```
rankScore = log1p(hfUpvotes) × 10
          + totalDirectionScore × 2
          + interestScore
```

优先级：HF 点赞（对数加权）> 方向匹配 > 兴趣关键词 > 时效（同分时）

### 7.5 LLM 质量评分（二次排名）

- 在关键词排名完成后，对**所有论文**调用 LLM 进行 1–10 的质量评分
- 评分后按 LLM Score 重排（若 LLM 调用失败，维持关键词排名）
- LLM 同时输出对每篇论文的一句话总结（`llmSummary`）

---

## 8. 每日 Pipeline

### 8.1 完整执行步骤

```
1. 加载配置、运行状态（state.json）、去重表（seen_ids.json）
2. 构建 arXiv 查询参数（时间窗口：now - timeWindowHours）
3. 拉取 arXiv 论文 → 解析 Atom XML → 时间过滤
4. 拉取 HuggingFace Daily Papers → 与 arXiv 结果合并
5. 去重（过滤 seen_ids 中已有的 paper ID）
6. 计算 interestHits、directionScores、topDirections
7. 计算 hotness，识别 trending papers
8. 综合排名（rankScore）
9. LLM 质量评分（1–10），按 LLM Score 重排
10. 调用 LLM 生成每日摘要（取 Top 10 论文入 prompt）
11. 写入 inbox/YYYY-MM-DD.md
12. 写入 papers/YYYY-MM-DD.json（完整快照）
13. 更新 seen_ids.json（标记本次所有论文）
14. 更新 state.json（lastDailyRun）
15. 追加 runs.log
```

### 8.2 错误处理策略

| 故障点 | 处理方式 |
|--------|----------|
| arXiv 拉取失败 | 写入 inbox/YYYY-MM-DD.md，内含错误信息 + 空论文列表 |
| HF 拉取失败 | 跳过 HF 部分，arXiv 结果继续处理 |
| LLM 评分失败 | 跳过 LLM 评分，维持关键词排名继续 |
| LLM 摘要生成失败 | 写入 markdown，摘要区标注"LLM 调用失败"原因 |
| 写文件失败 | 记录错误到 state.json + runs.log |

**核心原则：任何单步失败不阻断产物输出，当日文件必须落盘。**

### 8.3 每日 Markdown 结构

```markdown
---
type: paper-daily
date: 2026-02-28
sources: [arxiv, hf]
categories: [cs.AI, cs.LG, cs.CL]
keywords: [...]
interestKeywords: [...]
---

# Paper Daily — 2026-02-28

## Top Directions Today
- Agentic RL (score: 12.4, papers: 5)
- RLHF & Post-training (score: 9.1, papers: 3)
...

## 今日要点（AI 总结）
（LLM 生成内容）

## HuggingFace Daily Papers
（HF 当日热门论文，含点赞数、连续出现天数）

## All Papers (ranked)
1. **Title** — LLM 一句话总结
   - Directions: A, B
   - Interest hits: k1, k2
   - HF Upvotes: 42 | LLM Score: 8
   - Links: [arXiv](...), [PDF](...)
   - Authors: ...

## Trending Papers
（高热度但方向/兴趣得分为 0 的论文）
```

---

## 9. 回补 Pipeline（Backfill）

### 9.1 触发方式

通过命令面板 `Backfill daily summaries for date range` 打开对话框，输入：
- `startDate`（YYYY-MM-DD）
- `endDate`（YYYY-MM-DD）

### 9.2 执行逻辑

1. 校验 startDate ≤ endDate
2. 校验日期跨度 ≤ `backfillMaxDays`（默认 30）
3. 对每一天 D：
   - 以 [D 00:00, D 23:59] UTC 为时间窗口调用每日 pipeline
   - `skipDedup: false`（新出现的论文仍标记入去重表）
4. 实时 progress 回调更新对话框状态
5. 返回：`{processed: string[], errors: Record<date, string>}`

**注意：** 当前实现允许覆盖已存在的日期文件（会写入 log）。

---

## 10. 去重策略

- 数据结构：`Map<paperId, firstSeenDate (YYYY-MM-DD)>`
- 判断：论文已在 `seen_ids.json` 中 → 跳过
- 写入时机：每日 pipeline 结束时，批量 `markSeenBatch()`
- 自动清理：仅保留 90 天内的记录（`prune(keepDays=90)`）
- 手动清空：Settings 页面提供"Clear Dedup Cache"按钮

---

## 11. 命令列表

| 命令 ID | 显示名称 | 功能 |
|---------|----------|------|
| `run-daily-now` | Run daily fetch & summarize now | 立即执行每日 pipeline |
| `backfill` | Backfill daily summaries for date range | 打开回补对话框 |
| `rebuild-index` | Rebuild index from local cache | 重新从磁盘加载去重表 |
| `open-settings` | Open settings | 跳转到插件设置页 |

> 周报/月报命令（CLAUDE.md 中规划）当前**未实现**。

---

## 12. Settings UI

### 各设置分区

1. **arXiv Fetch**：分类、关键词、兴趣关键词（`keyword:weight` 格式）、条数、时间窗口、排序方式
2. **Directions & Themes**：方向 TopK、方向配置 JSON 编辑器（高级）
3. **LLM Provider**：预设按钮（8 个）、baseUrl、API Key、模型选择、温度、MaxTokens、三个 Prompt 模板
4. **Output**：输出根目录、语言、包含摘要、包含 PDF 链接
5. **Scheduling**：每日运行时间
6. **Test**：连通性测试按钮、立即运行按钮、实时状态显示
7. **Trending Papers**：开关、TopK、最低热度阈值
8. **HuggingFace Papers**：开关、回溯天数、HF 去重开关
9. **RSS Sources（Beta）**：开关（灰显）、Feed URL 列表
10. **PDF Download**：保存 PDF 开关
11. **Dedup Cache**：清空缓存按钮
12. **Backfill**：最大回补天数

---

## 13. LLM 接入实现

### OpenAI Compatible Provider

- 使用 Obsidian `requestUrl()` 发起 HTTP 请求（绕过 CORS）
- POST `{baseUrl}/chat/completions`，Bearer Token 认证
- 支持 DeepSeek、Qwen、GLM、Kimi、MiniMax 等兼容接口
- 响应取 `choices[0].message.content`

### Anthropic Provider

- 使用 `@anthropic-ai/sdk`，`dangerouslyAllowBrowser: true`
- 调用 `client.messages.create()`
- 响应取 `content.find(b => b.type === "text").text`

---

## 14. 模块结构

```
src/
  main.ts                   # 插件入口、命令注册、BackfillModal
  settings.ts               # Settings UI（974 行，最大文件）

  types/
    paper.ts                # Paper、FetchParams、RunState 类型定义
    config.ts               # 全部 Settings 类型定义

  sources/
    source.ts               # PaperSource 接口定义
    arxivSource.ts          # arXiv Atom API 拉取与解析（已实现）
    hfSource.ts             # HuggingFace Daily Papers 拉取（已实现）
    rssSource.ts            # RSS 来源（Stub）
    customApiSource.ts      # 自定义 API 来源（Stub）

  scoring/
    interest.ts             # 兴趣关键词匹配与加权评分
    directions.ts           # 方向评分与聚合
    hotness.ts              # 热度分计算
    rank.ts                 # 综合排名（含 HF upvotes）

  llm/
    provider.ts             # LLMProvider 接口
    openaiCompatible.ts     # OpenAI Compatible 实现
    anthropicProvider.ts    # Anthropic Claude 实现

  storage/
    vaultWriter.ts          # Obsidian vault 文件读写封装
    stateStore.ts           # 运行状态持久化
    dedupStore.ts           # 论文去重表
    snapshotStore.ts        # 每日论文快照读写
    hfTrackStore.ts         # HF 出现追踪
    paperDownloader.ts      # PDF 下载（限速）

  scheduler/
    scheduler.ts            # 定时器（60s tick，按配置时间触发）

  pipeline/
    dailyPipeline.ts        # 每日 pipeline（462 行，核心）
    backfillPipeline.ts     # 回补 pipeline
```

---

## 15. 功能实现现状

### 已完整实现

- arXiv 论文拉取（含限速重试）
- HuggingFace Daily Papers 拉取（含回溯 + 连续追踪）
- 兴趣关键词匹配与加权评分
- 方向评分（9 个预设方向）
- 热度评分（4 维度，上限 12）
- 综合排名（HF upvotes + 方向 + 兴趣 + 时效）
- LLM 质量评分（1–10，二次重排）
- 每日 AI 摘要生成（结构化 Markdown）
- 每日 Markdown 输出（含方向/命中/评分）
- 每日 JSON 快照
- PDF 下载（限速，跳过已存在）
- 去重（seen_ids.json，90 天自动清理）
- 历史回补（日期范围 → 批量每日 pipeline）
- 错误容错（fetch/LLM 失败仍落盘）
- 定时调度（每日自动运行）
- 运行日志（runs.log）
- Settings UI（双语，8 个 LLM 预设）
- OpenAI Compatible LLM 接入
- Anthropic Claude LLM 接入

### 已预留接口（Stub，未实现）

- RSS 来源解析
- 自定义 API 来源
- 周报 pipeline
- 月报 pipeline

---

## 16. 未来扩展方向（当前未实现）

以下功能在 CLAUDE.md 中规划，代码中尚无实现，留作后续迭代：

1. **周报 Pipeline**：读取过去 7 天 JSON 快照 → 聚合趋势 → LLM 生成周报 → `weekly/YYYY-Www.md`
2. **月报 Pipeline**：读取当月所有快照 → 方向演变分析 → `monthly/YYYY-MM.md`
3. **RSS 来源**：解析任意 RSS Feed，统一规范为 `Paper` 格式
4. **自定义 API 来源**：接入第三方论文 API
5. **周报/月报定时触发**：周六 18:00、每月 1 日 09:00
6. **UI 面板**：插件内置论文浏览界面
7. **BibTeX 导出**
8. **RAG / 全文检索**

---

*文档版本：v0.1 | 生成日期：2026-02-28 | 基于代码实际行为反推*
